<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Mongothon by tleach</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>Mongothon</h1>
          <h2>A lightweight Mongo object-document mapping abstraction layer over PyMongo</h2>
        </header>

        <section id="downloads" class="clearfix">
          <a href="https://github.com/tleach/mongothon/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/tleach/mongothon/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/tleach/mongothon" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section>

        <hr>

        <section id="main_content">
          <h1>
<a name="mongothon" class="anchor" href="#mongothon"><span class="octicon octicon-link"></span></a>Mongothon</h1>

<p>Mongothon is a MongoDB object-document mapping API for Python, loosely based on the awesome <a href="http://mongoosejs.com/">mongoose.js</a> library.</p>

<p><a href="https://travis-ci.org/tleach/mongothon"><img src="https://travis-ci.org/tleach/mongothon.png?branch=master" alt="build status" title="Build status"></a></p>

<h1>
<a name="installation" class="anchor" href="#installation"><span class="octicon octicon-link"></span></a>Installation</h1>

<p>Install via easy_install:</p>

<pre><code>easy_install mongothon
</code></pre>

<p>Or, via pip:</p>

<pre><code>pip install mongothon
</code></pre>

<h1>
<a name="getting-started" class="anchor" href="#getting-started"><span class="octicon octicon-link"></span></a>Getting Started</h1>

<p>Mongothon allows you to declaratively express the structure and contraints of your Mongo document in a reusable Schema using Python dicts. Schemas can then be used to generate reusable Model classes which can be used in your application to perform IO with your associated Mongo collection.</p>

<h2>
<a name="example" class="anchor" href="#example"><span class="octicon octicon-link"></span></a>Example</h2>

<p>Define the Mongo document structure and constraints in a Schema:</p>

<div class="highlight highlight-python"><pre><span class="n">car_schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
    <span class="s">"make"</span><span class="p">:</span>         <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">basestring</span><span class="p">,</span> <span class="s">"required"</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
    <span class="s">"model"</span><span class="p">:</span>        <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">basestring</span><span class="p">,</span> <span class="s">"required"</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
    <span class="s">"num_wheels"</span><span class="p">:</span>   <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>        <span class="s">"default"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s">"validates"</span><span class="p">:</span> <span class="n">gte</span><span class="p">(</span><span class="mi">0</span><span class="p">)}</span>
    <span class="s">"color"</span><span class="p">:</span>        <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">basestring</span><span class="p">,</span> <span class="s">"validates"</span><span class="p">:</span> <span class="n">one_of</span><span class="p">(</span><span class="s">"red"</span><span class="p">,</span> <span class="s">"green"</span><span class="p">,</span> <span class="s">"blue"</span><span class="p">)}</span>
<span class="p">})</span>
</pre></div>

<p>Generate a reusable model class from the Schema and pymongo collection:</p>

<div class="highlight highlight-python"><pre><span class="n">Car</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">car_schema</span><span class="p">,</span> <span class="n">db</span><span class="p">[</span><span class="s">'car'</span><span class="p">])</span>
</pre></div>

<p>Find, modify and save a document:</p>

<div class="highlight highlight-python"><pre><span class="n">car</span> <span class="o">=</span> <span class="n">Car</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">some_id</span><span class="p">)</span>
<span class="n">car</span><span class="p">[</span><span class="s">'color'</span><span class="p">]</span> <span class="o">=</span> <span class="s">"green"</span>
<span class="n">car</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>

<p>Create a new document:</p>

<div class="highlight highlight-python"><pre><span class="n">car</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Car</span><span class="p">({</span>
    <span class="s">"make"</span><span class="p">:</span>     <span class="s">"Ford"</span><span class="p">,</span>
    <span class="s">"model"</span><span class="p">:</span>    <span class="s">"F-150"</span><span class="p">,</span>
    <span class="s">"color"</span><span class="p">:</span>    <span class="s">"red"</span>
<span class="p">})</span>
<span class="n">car</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>

<p>Remove a document</p>

<div class="highlight highlight-python"><pre><span class="n">car</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
</pre></div>

<p>Validate a document</p>

<div class="highlight highlight-python"><pre><span class="n">car</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Car</span><span class="p">({</span>
    <span class="s">"make"</span><span class="p">:</span>         <span class="s">"Ford"</span><span class="p">,</span>
    <span class="s">"model"</span><span class="p">:</span>        <span class="s">"F-150"</span><span class="p">,</span>
    <span class="s">"num_wheels"</span><span class="p">:</span>   <span class="o">-</span><span class="mi">1</span>
    <span class="s">"color"</span><span class="p">:</span>        <span class="s">"red"</span>
<span class="p">})</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">car</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
<span class="k">except</span> <span class="n">ValidationException</span><span class="p">:</span>
    <span class="c"># num_wheels should be &gt;= 0</span>

</pre></div>

<h1>
<a name="api-reference" class="anchor" href="#api-reference"><span class="octicon octicon-link"></span></a>API Reference</h1>

<h2>
<a name="schemas" class="anchor" href="#schemas"><span class="octicon octicon-link"></span></a>Schemas</h2>

<h3>
<a name="types" class="anchor" href="#types"><span class="octicon octicon-link"></span></a>Types</h3>

<p>Each field in a Mongothon schema must be given a type by adding a <code>"type"</code> key to the field spec dict. For example, this schema declares a single <code>"name"</code> field with a type of <code>basestring</code>:</p>

<div class="highlight highlight-python"><pre><span class="n">schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span><span class="s">"name"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">basestring</span><span class="p">}})</span>
</pre></div>

<p>Supported field types are: <code>basestring</code>, <code>int</code>, <code>float</code>, <code>datetime</code>, <code>long</code>, <code>bool</code>, <code>Schema</code> (see Nested schemas below) and <code>Mixed</code>.</p>

<h4>
<a name="the-mixed-type" class="anchor" href="#the-mixed-type"><span class="octicon octicon-link"></span></a>The "Mixed" type</h4>

<p>The <code>Mixed</code> type allows you to indicate that a field supports values of multiple types. Use of this type is generally not encouraged (consistent field typing makes life easier) but is sometimes necessary.
<code>Mixed</code> can be provided as a class to indicate a value of any supported type may be used in a given field:</p>

<div class="highlight highlight-python"><pre><span class="n">schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span><span class="s">"misc"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="n">Mixed</span><span class="p">}})</span>  <span class="c"># all types are valid in this field</span>
</pre></div>

<p>You can also instantiate <code>Mixed</code> with a list of sub-types to indicate that a value of one of a subset of supported types may be used in the field:</p>

<div class="highlight highlight-python"><pre><span class="n">schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span><span class="s">"external_id"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="n">Mixed</span><span class="p">(</span><span class="nb">basestring</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ObjectId</span><span class="p">)}})</span>  <span class="c"># only basestring, int and ObjectId are supported</span>
</pre></div>

<p>If you attempt to save a model containing a value of the wrong type for a given a field a <code>ValidationException</code> will be thrown.</p>

<h3>
<a name="mandatory-fields" class="anchor" href="#mandatory-fields"><span class="octicon octicon-link"></span></a>Mandatory fields</h3>

<p>You can require a field to be present in a document by adding <code>"required": True</code> to the Schema:</p>

<div class="highlight highlight-python"><pre><span class="n">schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span><span class="s">"name"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">basestring</span><span class="p">,</span> <span class="s">"required"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}})</span>
</pre></div>

<p>By default all fields are not required.
If <code>save()</code> is called on model which does not contain a value for a required field then the model will raise a <code>ValidationException</code>.</p>

<h3>
<a name="defaults" class="anchor" href="#defaults"><span class="octicon octicon-link"></span></a>Defaults</h3>

<p>Schemas allow you to specify default values for fields which are used in the event a value is not provided in a given document.
A default can either be specified as literal:</p>

<div class="highlight highlight-python"><pre><span class="n">schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span><span class="s">"num_wheels"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">"default"</span><span class="p">:</span> <span class="mi">4</span><span class="p">}})</span>
</pre></div>

<p>or as a reference to parameterless function which will be called at the point the document is saved:</p>

<div class="highlight highlight-python"><pre><span class="kn">import</span> <span class="nn">datetime</span>
<span class="n">schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span><span class="s">"created_date"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="s">"default"</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">}})</span>
</pre></div>

<h3>
<a name="validation" class="anchor" href="#validation"><span class="octicon octicon-link"></span></a>Validation</h3>

<p>Mongothon allows you to specify validation for a field using the <code>"validates"</code> key in the field spec.
You can specify a single validator:</p>

<div class="highlight highlight-python"><pre><span class="n">schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span><span class="s">"color"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">basestring</span><span class="p">,</span> <span class="s">"validates"</span><span class="p">:</span> <span class="n">one_of</span><span class="p">(</span><span class="s">"red"</span><span class="p">,</span> <span class="s">"green"</span><span class="p">,</span> <span class="s">"blue"</span><span class="p">)}})</span>
</pre></div>

<p>or multiple validators:</p>

<div class="highlight highlight-python"><pre><span class="n">schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span><span class="s">"num_wheels"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">"validates"</span><span class="p">:</span> <span class="p">[</span><span class="n">gte</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">lte</span><span class="p">(</span><span class="mi">6</span><span class="p">)]}})</span>
</pre></div>

<h4>
<a name="provided-validators" class="anchor" href="#provided-validators"><span class="octicon octicon-link"></span></a>Provided validators</h4>

<p>Mongothon provides the following validators out-of-the-box:</p>

<div class="highlight highlight-python"><pre><span class="c"># Validator                         # Validates that the field...</span>
<span class="n">gte</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>                          <span class="c"># is greater than or equal to the given value</span>
<span class="n">lte</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>                          <span class="c"># is less than or equal to the given value</span>
<span class="n">gt</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>                           <span class="c"># is greater than the given value</span>
<span class="n">lt</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>                           <span class="c"># is less than the given value</span>
<span class="n">between</span><span class="p">(</span><span class="n">min_value</span><span class="p">,</span> <span class="n">max_value</span><span class="p">)</span>       <span class="c"># is between the given min and max values</span>
<span class="n">length</span><span class="p">(</span><span class="n">min_length</span><span class="p">,</span> <span class="p">[</span><span class="n">max_length</span><span class="p">])</span>    <span class="c"># is at least the given min length and (optionally) at most the given max length</span>
<span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>                      <span class="c"># matches the given regex pattern</span>
<span class="n">one_of</span><span class="p">(</span><span class="n">values</span><span class="o">...</span><span class="p">)</span>                   <span class="c"># is equal to one of the given values</span>
<span class="n">is_url</span><span class="p">()</span>                            <span class="c"># is a valid URL</span>
<span class="n">is_email</span><span class="p">()</span>                          <span class="c"># is a valid email address</span>
</pre></div>

<h4>
<a name="creating-custom-validators" class="anchor" href="#creating-custom-validators"><span class="octicon octicon-link"></span></a>Creating custom validators</h4>

<p>In addition to the provided validators it's easy to create your own custom validators.
To create a custom validator:</p>

<ul>
<li>declare a function which accepts any arguments you want to provide to the validation algorithm</li>
<li>the function should itself return a function which will ultimately be called by Mongothon when validating a field value. The function should:

<ul>
<li>accept a single argument - the field value being validated</li>
<li>return nothing if the given value is valid</li>
<li>return a string describing the validation error if the value is invalid</li>
</ul>
</li>
</ul><p>Here's the declaration of an example custom validator:</p>

<div class="highlight highlight-python"><pre><span class="k">def</span> <span class="nf">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">"String must start with </span><span class="si">%s</span><span class="s">"</span> <span class="o">%</span> <span class="n">prefix</span>

<span class="c"># Usage:</span>
<span class="n">schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span><span class="s">"full_name"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">basestring</span><span class="p">,</span> <span class="s">"validates"</span><span class="p">:</span> <span class="n">startswith</span><span class="p">(</span><span class="s">"Mr"</span><span class="p">)}})</span>
</pre></div>

<h3>
<a name="nested-schemas" class="anchor" href="#nested-schemas"><span class="octicon octicon-link"></span></a>Nested schemas</h3>

<p>Schemas may be nested within one another in order to describe the structure of documents containing deep graphs.</p>

<p>Nested can either be declared inline:</p>

<div class="highlight highlight-python"><pre><span class="n">blog_post_schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
    <span class="s">"author"</span><span class="p">:</span>   <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="n">Schema</span><span class="p">({</span><span class="s">"first_name"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">basestring</span><span class="p">},</span> <span class="s">"last_name"</span><span class="p">:</span> <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">basestring</span><span class="p">}})},</span>
    <span class="s">"title"</span><span class="p">:</span>    <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">basestring</span><span class="p">},</span>
    <span class="s">"content"</span><span class="p">:</span>  <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">basestring</span><span class="p">}</span>
<span class="p">})</span>

</pre></div>

<p>or declared in isolation and then referenced (and potentially reused between multiple parent schemas):</p>

<div class="highlight highlight-python"><pre><span class="n">name_schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
    <span class="s">"first_name"</span><span class="p">:</span>   <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">basestring</span><span class="p">},</span>
    <span class="s">"last_name"</span><span class="p">:</span>    <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">basestring</span><span class="p">}</span>
<span class="p">})</span>

<span class="n">blog_post_schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
    <span class="s">"author"</span><span class="p">:</span>   <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="n">name_schema</span><span class="p">},</span>
    <span class="s">"title"</span><span class="p">:</span>    <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">basestring</span><span class="p">},</span>
    <span class="s">"content"</span><span class="p">:</span>  <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">basestring</span><span class="p">}</span>
<span class="p">})</span>

<span class="n">comment_schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
    <span class="s">"author"</span><span class="p">:</span>   <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="n">name_schema</span><span class="p">,</span> <span class="s">"required"</span><span class="p">:</span><span class="bp">True</span><span class="p">},</span>
    <span class="s">"comment"</span><span class="p">:</span>  <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="n">base_string</span><span class="p">}</span>
<span class="p">})</span>

</pre></div>

<p>In each case the nested schema is provided as the <code>type</code> parameter in the parent field's spec and can be declared as <code>"required"=True</code> if so desired. Any validation present within the nested schema is applied wherever the schema
is used.</p>

<h3>
<a name="embedded-collections" class="anchor" href="#embedded-collections"><span class="octicon octicon-link"></span></a>Embedded collections</h3>

<p>As well as nesting schemas directly under fields, Mongothon supports embedded collections within documents. To declare an embedded collection, simply declare the type of the embedded items using Python list syntax:</p>

<div class="highlight highlight-python"><pre><span class="n">line_item_schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
    <span class="s">"price"</span><span class="p">:</span>        <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">"required"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    <span class="s">"item_name"</span><span class="p">:</span>    <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">basestring</span><span class="p">,</span> <span class="s">"required"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
<span class="p">})</span>

<span class="n">order_schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
    <span class="s">"line_items"</span><span class="p">:</span>   <span class="p">[</span><span class="n">line_item_schema</span><span class="p">]</span>
    <span class="s">"total_due"</span><span class="p">:</span>    <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">int</span><span class="p">}</span>
<span class="p">})</span>
</pre></div>

<p>Simple primitive types can be embedded as well as full schemas:</p>

<div class="highlight highlight-python"><pre><span class="n">bookmark_schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
    <span class="s">"url"</span><span class="p">:</span>      <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">basestring</span><span class="p">},</span>
    <span class="s">"tags"</span><span class="p">:</span>     <span class="p">[</span><span class="nb">basestring</span><span class="p">]</span>
<span class="p">})</span>
</pre></div>

<h2>
<a name="models" class="anchor" href="#models"><span class="octicon octicon-link"></span></a>Models</h2>

<p>Where Schemas are used to declare the structure and constraints of a Mongo document, Models allow those Schemas to be used in interacting with the database to enforce that document structure.</p>

<h3>
<a name="creating-a-model-class" class="anchor" href="#creating-a-model-class"><span class="octicon octicon-link"></span></a>Creating a model class</h3>

<p>To create a new model class from an existing schema, use the <code>create_model</code> method:</p>

<div class="highlight highlight-python"><pre><span class="n">Order</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">order_schema</span><span class="p">,</span> <span class="n">db</span><span class="p">[</span><span class="s">'orders'</span><span class="p">])</span>
</pre></div>

<p>The second argument which must be provided to <code>create_model</code> is the PyMongo collection object associated with the underlying MongoDB collection to be associated with the model.</p>

<h3>
<a name="class-methods" class="anchor" href="#class-methods"><span class="octicon octicon-link"></span></a>Class methods</h3>

<p>Model classes provide a number of class methods which can be used to interact with the underlying collection as a whole.</p>

<h4>
<a name="finding-documents" class="anchor" href="#finding-documents"><span class="octicon octicon-link"></span></a>Finding documents</h4>

<p>Model classes can be used to find individual documents by ID:</p>

<div class="highlight highlight-python"><pre><span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">some_id</span><span class="p">)</span>  <span class="c"># returns an instance of Order</span>
</pre></div>

<p>or using a search condition:</p>

<div class="highlight highlight-python"><pre><span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s">'total_due'</span><span class="p">:</span> <span class="p">{</span><span class="s">'$gte'</span><span class="p">:</span> <span class="s">'10'</span><span class="p">}})</span>  <span class="c"># returns an instance of Order</span>
</pre></div>

<p>Selections of documents can also be retrieved using search criteria:</p>

<div class="highlight highlight-python"><pre><span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s">'total_due'</span><span class="p">:</span> <span class="p">{</span><span class="s">'$gte'</span><span class="p">:</span> <span class="s">'10'</span><span class="p">}})</span>  <span class="c"># returns a cursor containing Order instances</span>
</pre></div>

<h4>
<a name="updating-documents" class="anchor" href="#updating-documents"><span class="octicon octicon-link"></span></a>Updating documents</h4>

<p>Model classes can be used to perform updates on the collection:</p>

<div class="highlight highlight-python"><pre><span class="n">Order</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">'total_due'</span><span class="p">:</span> <span class="p">{</span><span class="s">'$gte'</span><span class="p">:</span> <span class="s">'10'</span><span class="p">}},</span> <span class="p">{</span><span class="s">'$unset'</span><span class="p">:</span> <span class="p">{</span><span class="s">'line_items'</span><span class="p">:</span> <span class="mi">1</span><span class="p">}})</span>
</pre></div>

<h4>
<a name="counting-items" class="anchor" href="#counting-items"><span class="octicon octicon-link"></span></a>Counting items</h4>

<div class="highlight highlight-python"><pre><span class="n">Order</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>

<h4>
<a name="custom-class-methods" class="anchor" href="#custom-class-methods"><span class="octicon octicon-link"></span></a>Custom class methods</h4>

<p>You can dynamically add custom class methods to your model by using the model's <code>class_method</code> decorator function. These are useful for adding custom finder methods to your model:</p>

<div class="highlight highlight-python"><pre><span class="nd">@BlogPost.class_method</span>
<span class="k">def</span> <span class="nf">find_by_author</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">author</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s">"author"</span><span class="p">:</span> <span class="n">author</span><span class="p">})</span>

<span class="n">posts</span> <span class="o">=</span> <span class="n">BlogPost</span><span class="o">.</span><span class="n">find_by_author</span><span class="p">(</span><span class="s">"Jeff Atwood"</span><span class="p">)</span>
</pre></div>

<h3>
<a name="instance-methods" class="anchor" href="#instance-methods"><span class="octicon octicon-link"></span></a>Instance methods</h3>

<p>Instances of models allow documents to be easily created, manipulated, save and deleted.</p>

<h4>
<a name="creating-documents" class="anchor" href="#creating-documents"><span class="octicon octicon-link"></span></a>Creating documents</h4>

<p>Create a new instance of a model by passing the document as a Python dict into the constructor:</p>

<div class="highlight highlight-python"><pre><span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">({</span>
    <span class="s">"line_items"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="s">"item_name"</span><span class="p">:</span> <span class="s">"iPhone 5"</span><span class="p">,</span> <span class="s">"price"</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"item_name"</span><span class="p">:</span> <span class="s">"Mac Mini"</span><span class="p">,</span> <span class="s">"price"</span><span class="p">:</span> <span class="mi">500</span><span class="p">}</span>
    <span class="p">],</span>
    <span class="s">"total_due"</span><span class="p">:</span> <span class="mi">700</span>
<span class="p">})</span>
</pre></div>

<h4>
<a name="saving-documents" class="anchor" href="#saving-documents"><span class="octicon octicon-link"></span></a>Saving documents</h4>

<p>In order to persist document changes to the DB, the model can be saved:</p>

<div class="highlight highlight-python"><pre><span class="n">order</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>

<p>Saving an existing, previously loaded document will cause it to be updated. Saving a new document will cause it to be inserted.
In all cases, saving a document results in schema defaults being applied where appropriate and the document being validated before it is saved to the database. In the event of a validation failure <code>save()</code> will raise a ValidationException.</p>

<h4>
<a name="deleting-documents" class="anchor" href="#deleting-documents"><span class="octicon octicon-link"></span></a>Deleting documents</h4>

<p>A document may be removed from the underlying collection by calling the <code>remove()</code> method on the associated model instance:</p>

<div class="highlight highlight-python"><pre><span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">some_id</span><span class="p">)</span>
<span class="n">order</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>  <span class="c"># document is removed from the DB</span>
</pre></div>

<h4>
<a name="reload" class="anchor" href="#reload"><span class="octicon octicon-link"></span></a>Reload</h4>

<p>You can easily reload a model instance from the database by calling the <code>reload</code> method on an instance:</p>

<div class="highlight highlight-python"><pre><span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">some_id</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">order</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
</pre></div>

<h4>
<a name="custom-instance-methods" class="anchor" href="#custom-instance-methods"><span class="octicon octicon-link"></span></a>Custom instance methods</h4>

<p>Custom instance methods can be added to a model using the model's <code>instance_method</code> decorator. This comes in useful when you want to wrap up common operations on a document:</p>

<div class="highlight highlight-python"><pre><span class="nd">@Order.instance_method</span>
<span class="k">def</span> <span class="nf">add_line_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">line_items</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s">'item_name'</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s">'price'</span><span class="p">:</span> <span class="n">price</span><span class="p">})</span>

<span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">some_id</span><span class="p">)</span>
<span class="n">order</span><span class="o">.</span><span class="n">add_line_item</span><span class="p">(</span><span class="s">"iPad Mini"</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
<span class="n">order</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>

<h3>
<a name="scopes-beta" class="anchor" href="#scopes-beta"><span class="octicon octicon-link"></span></a>"Scopes" (beta)</h3>

<p>Scopes are a dynamic way of attaching reusable sets of query options to a model which can then be chained together dynamically in order to run actual queries against the model's underlying collection.</p>

<p>For example:</p>

<div class="highlight highlight-python"><pre><span class="nd">@Order.scope</span>
<span class="k">def</span> <span class="nf">before</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">"created_date"</span><span class="p">:</span> <span class="p">{</span><span class="s">"$lt"</span><span class="p">:</span> <span class="n">date</span><span class="p">}}</span>

<span class="nd">@Order.scope</span>
<span class="k">def</span> <span class="nf">single_item</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">"items"</span><span class="p">:</span> <span class="p">{</span><span class="s">"$size"</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}</span>

<span class="c"># Obtains a list of orders which were created before 20120101 which have a single line item.</span>
<span class="n">orders</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">single_item</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>

<h4>
<a name="implementing-scope-functions" class="anchor" href="#implementing-scope-functions"><span class="octicon octicon-link"></span></a>Implementing scope functions</h4>

<p>A "scope" function is simply a function which returns up to three return values:</p>

<ul>
<li>A query dict</li>
<li>A projection dict</li>
<li>An options dict, containing a list of kwargs suitable for passing to PyMongo's <code>find</code> method.</li>
</ul><p>A scope is registered with a given model by using the model's <code>scope</code> decorator.</p>

<p>Some example scopes:</p>

<div class="highlight highlight-python"><pre><span class="nd">@BlogPost.scope</span>
<span class="k">def</span> <span class="nf">author</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">"""A scope which restricts the query to only blog posts by the given author"""</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">"name"</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span>

<span class="nd">@BlogPost.scope</span>
<span class="k">def</span> <span class="nf">id_only</span><span class="p">():</span>
    <span class="sd">"""Only return the ID from the query"""</span>
    <span class="k">return</span> <span class="p">{},</span> <span class="p">{</span><span class="s">"_id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

<span class="nd">@BlogPost.scope</span>
<span class="k">def</span> <span class="nf">by_created_date</span><span class="p">():</span>
    <span class="sd">"""Sorts the query results by created date"""</span>
    <span class="k">return</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{</span><span class="s">"sort"</span><span class="p">:</span> <span class="p">[</span><span class="s">"created_date"</span><span class="p">,</span> <span class="mi">1</span><span class="p">]}</span>
</pre></div>

<h4>
<a name="using-scopes" class="anchor" href="#using-scopes"><span class="octicon octicon-link"></span></a>Using scopes</h4>

<p>Scope functions, once registered to a given model, can be called on the model class to dynamically build up a query context in a chainable manner.</p>

<p>Once the query context has been built it can be executed as an actual query against the database by calling <code>execute()</code>.</p>

<div class="highlight highlight-python"><pre><span class="c"># Finds all BlogPosts with a given author, only returning their IDs</span>
<span class="n">posts</span> <span class="o">=</span> <span class="n">BlogPost</span><span class="o">.</span><span class="n">author</span><span class="p">(</span><span class="s">"bob"</span><span class="p">)</span><span class="o">.</span><span class="n">id_only</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>

<p>The builder API which allows scopes to be chained together in this manner also implements a Python iterator which will call <code>execute()</code> behind the scenes if you attempt to index into it:</p>

<div class="highlight highlight-python"><pre><span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">BlogPost</span><span class="o">.</span><span class="n">author</span><span class="p">(</span><span class="s">"bob"</span><span class="p">)</span><span class="o">.</span><span class="n">id_only</span><span class="p">():</span>
    <span class="c"># Do something</span>
</pre></div>

<h3>
<a name="middleware" class="anchor" href="#middleware"><span class="octicon octicon-link"></span></a>Middleware</h3>

<p>Models allow you to register middleware functions which will be passed flow control at various specific points in the lifecycle of a model.</p>

<p>Currently supported middleware events are:</p>

<p><code>before_save</code> - called just before a document is saved
<code>after_save</code> - called just after a document is saved
<code>before_validate</code> - called just before a document is validated
<code>after_validate</code> - called just after a document is validated</p>

<p>In each case the registered middleware function will be passed the document object.</p>

<p>Example:</p>

<div class="highlight highlight-python"><pre><span class="k">def</span> <span class="nf">log_saved</span><span class="p">(</span><span class="n">doc</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Saved order {0}"</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>

<span class="c"># Register the function</span>
<span class="n">Order</span><span class="o">.</span><span class="n">after_save</span><span class="p">(</span><span class="n">log_saved</span><span class="p">)</span>
</pre></div>

<p>There is no limit to the number of middleware functions which can be registered.</p>

<h3>
<a name="model-state" class="anchor" href="#model-state"><span class="octicon octicon-link"></span></a>Model State</h3>

<p>Mongothon models provide a few handy methods which let you determine the document's current persistence state:</p>

<div class="highlight highlight-python"><pre><span class="n">post</span> <span class="o">=</span> <span class="n">BlogPost</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">post</span><span class="o">.</span><span class="n">is_new</span><span class="p">()</span>

<span class="n">post</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">post</span><span class="o">.</span><span class="n">is_new</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">post</span><span class="o">.</span><span class="n">is_persisted</span><span class="p">()</span>

<span class="n">post</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">post</span><span class="o">.</span><span class="n">is_new</span><span class="p">()</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">post</span><span class="o">.</span><span class="n">is_persisted</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">port</span><span class="o">.</span><span class="n">is_deleted</span><span class="p">()</span>
</pre></div>

<h1>
<a name="developing-and-contributing" class="anchor" href="#developing-and-contributing"><span class="octicon octicon-link"></span></a>Developing and Contributing</h1>

<p>To run Mongothon's tests, simply run <code>python setup.py nosetests</code> at the command line.</p>

<p>All contributions submitted as GitHub pull requests are warmly received.</p>
        </section>

        <footer>
          Mongothon is maintained by <a href="https://github.com/tleach">tleach</a><br>
          This page was generated by <a href="http://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
        </footer>

        
      </div>
    </div>
  </body>
</html>