<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Mongothon : A lightweight Mongo object-document mapping abstraction layer over PyMongo" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Mongothon</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/gamechanger/mongothon">View on GitHub</a>

          <h1 id="project_title">Mongothon</h1>
          <h2 id="project_tagline">A lightweight Mongo object-document mapping abstraction layer over PyMongo</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/gamechanger/mongothon/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/gamechanger/mongothon/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a name="mongothon" class="anchor" href="#mongothon"><span class="octicon octicon-link"></span></a>Mongothon</h1>

<p>Mongothon is a MongoDB object-document mapping API for Python, loosely based on the awesome <a href="http://mongoosejs.com/">mongoose.js</a> library.</p>

<p><a href="https://travis-ci.org/gamechanger/mongothon"><img src="https://travis-ci.org/gamechanger/mongothon.png?branch=master" alt="build status" title="Build status"></a></p>

<h1>
<a name="installation" class="anchor" href="#installation"><span class="octicon octicon-link"></span></a>Installation</h1>

<p>Install via easy_install:</p>

<pre><code>easy_install mongothon
</code></pre>

<p>Or, via pip:</p>

<pre><code>pip install mongothon
</code></pre>

<h1>
<a name="getting-started" class="anchor" href="#getting-started"><span class="octicon octicon-link"></span></a>Getting Started</h1>

<p>Mongothon allows you to couple reusable schemas (based on the <a href="http://github.com/gamechanger/schemer">Schemer</a> API) with Model classes which can be used in your application to perform IO with your associated Mongo collection.</p>

<h2>
<a name="example" class="anchor" href="#example"><span class="octicon octicon-link"></span></a>Example</h2>

<p>Define the Mongo document structure and constraints in a Schema:</p>

<div class="highlight highlight-python"><pre><span class="kn">from</span> <span class="nn">mongothon</span> <span class="kn">import</span> <span class="n">Schema</span>

<span class="n">car_schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">({</span>
    <span class="s">"make"</span><span class="p">:</span>         <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">basestring</span><span class="p">,</span> <span class="s">"required"</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
    <span class="s">"model"</span><span class="p">:</span>        <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">basestring</span><span class="p">,</span> <span class="s">"required"</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
    <span class="s">"num_wheels"</span><span class="p">:</span>   <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>        <span class="s">"default"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s">"validates"</span><span class="p">:</span> <span class="n">gte</span><span class="p">(</span><span class="mi">0</span><span class="p">)}</span>
    <span class="s">"color"</span><span class="p">:</span>        <span class="p">{</span><span class="s">"type"</span><span class="p">:</span> <span class="nb">basestring</span><span class="p">,</span> <span class="s">"validates"</span><span class="p">:</span> <span class="n">one_of</span><span class="p">(</span><span class="s">"red"</span><span class="p">,</span> <span class="s">"green"</span><span class="p">,</span> <span class="s">"blue"</span><span class="p">)}</span>
<span class="p">})</span>
</pre></div>

<p>Generate a reusable model class from the Schema and pymongo collection:</p>

<div class="highlight highlight-python"><pre><span class="n">Car</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">car_schema</span><span class="p">,</span> <span class="n">db</span><span class="p">[</span><span class="s">'car'</span><span class="p">])</span>
</pre></div>

<p>Find, modify and save a document:</p>

<div class="highlight highlight-python"><pre><span class="n">car</span> <span class="o">=</span> <span class="n">Car</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">some_id</span><span class="p">)</span>
<span class="n">car</span><span class="p">[</span><span class="s">'color'</span><span class="p">]</span> <span class="o">=</span> <span class="s">"green"</span>
<span class="n">car</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>

<p>Create a new document:</p>

<div class="highlight highlight-python"><pre><span class="n">car</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Car</span><span class="p">({</span>
    <span class="s">"make"</span><span class="p">:</span>     <span class="s">"Ford"</span><span class="p">,</span>
    <span class="s">"model"</span><span class="p">:</span>    <span class="s">"F-150"</span><span class="p">,</span>
    <span class="s">"color"</span><span class="p">:</span>    <span class="s">"red"</span>
<span class="p">})</span>
<span class="n">car</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>

<p>Remove a document</p>

<div class="highlight highlight-python"><pre><span class="n">car</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
</pre></div>

<p>Validate a document</p>

<div class="highlight highlight-python"><pre><span class="n">car</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Car</span><span class="p">({</span>
    <span class="s">"make"</span><span class="p">:</span>         <span class="s">"Ford"</span><span class="p">,</span>
    <span class="s">"model"</span><span class="p">:</span>        <span class="s">"F-150"</span><span class="p">,</span>
    <span class="s">"num_wheels"</span><span class="p">:</span>   <span class="o">-</span><span class="mi">1</span>
    <span class="s">"color"</span><span class="p">:</span>        <span class="s">"red"</span>
<span class="p">})</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">car</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
<span class="k">except</span> <span class="n">ValidationException</span><span class="p">:</span>
    <span class="c"># num_wheels should be &gt;= 0</span>

</pre></div>

<h1>
<a name="api-reference" class="anchor" href="#api-reference"><span class="octicon octicon-link"></span></a>API Reference</h1>

<h2>
<a name="schemas" class="anchor" href="#schemas"><span class="octicon octicon-link"></span></a>Schemas</h2>

<p>Schemas in Mongothon are based almost completely on the Schema class provided by the <a href="http://github.com/gamechanger/schemer">Schemer</a> library. Take a look at the <a href="http://github.com/gamechanger/schemer">Schemer</a> docs for details of how to describe your document's structure, validation rules and defaults.</p>

<p>For convenience, Mongothon offers it's own <code>Schema</code> subclass which includes standard Schemer functionality but adds support for Mongo "_id" fields.</p>

<h2>
<a name="models" class="anchor" href="#models"><span class="octicon octicon-link"></span></a>Models</h2>

<p>Where Schemas are used to declare the structure and constraints of a Mongo document, Models allow those Schemas to be used in interacting with the database to enforce that document structure.</p>

<h3>
<a name="creating-a-model-class" class="anchor" href="#creating-a-model-class"><span class="octicon octicon-link"></span></a>Creating a model class</h3>

<p>To create a new model class from an existing schema, use the <code>create_model</code> method:</p>

<div class="highlight highlight-python"><pre><span class="n">Order</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">order_schema</span><span class="p">,</span> <span class="n">db</span><span class="p">[</span><span class="s">'orders'</span><span class="p">])</span>
</pre></div>

<p>The second argument which must be provided to <code>create_model</code> is the PyMongo collection object associated with the underlying MongoDB collection to be associated with the model.</p>

<h3>
<a name="class-methods" class="anchor" href="#class-methods"><span class="octicon octicon-link"></span></a>Class methods</h3>

<p>Model classes provide a number of class methods which can be used to interact with the underlying collection as a whole.</p>

<h4>
<a name="finding-documents" class="anchor" href="#finding-documents"><span class="octicon octicon-link"></span></a>Finding documents</h4>

<p>Model classes can be used to find individual documents by ID:</p>

<div class="highlight highlight-python"><pre><span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">some_id</span><span class="p">)</span>  <span class="c"># returns an instance of Order</span>
                                   <span class="c"># or throws NotFoundException</span>
</pre></div>

<p>or using a search condition:</p>

<div class="highlight highlight-python"><pre><span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s">'total_due'</span><span class="p">:</span> <span class="p">{</span><span class="s">'$gte'</span><span class="p">:</span> <span class="s">'10'</span><span class="p">}})</span>  <span class="c"># returns an instance of Order</span>
</pre></div>

<p>Selections of documents can also be retrieved using search criteria:</p>

<div class="highlight highlight-python"><pre><span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s">'total_due'</span><span class="p">:</span> <span class="p">{</span><span class="s">'$gte'</span><span class="p">:</span> <span class="s">'10'</span><span class="p">}})</span>  <span class="c"># returns a cursor containing Order instances</span>
</pre></div>

<h4>
<a name="updating-documents" class="anchor" href="#updating-documents"><span class="octicon octicon-link"></span></a>Updating documents</h4>

<p>Mongothon two mechanisms to run updates against documents.</p>

<h5>
<a name="modelupdate-static-method" class="anchor" href="#modelupdate-static-method"><span class="octicon octicon-link"></span></a><code>Model.update</code> (static method)</h5>

<p>The class method version of <code>update</code> is essentially a proxy for the underlying Pymongo collection object's <code>update</code> method and can be
called as such.</p>

<div class="highlight highlight-python"><pre><span class="n">Order</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">'total_due'</span><span class="p">:</span> <span class="p">{</span><span class="s">'$gte'</span><span class="p">:</span> <span class="mi">700</span><span class="p">}},</span> <span class="p">{</span><span class="s">'$unset'</span><span class="p">:</span> <span class="p">{</span><span class="s">'line_items'</span><span class="p">:</span> <span class="mi">1</span><span class="p">}})</span>
</pre></div>

<h5>
<a name="modelupdate_instance-instance-method" class="anchor" href="#modelupdate_instance-instance-method"><span class="octicon octicon-link"></span></a><code>model.update_instance</code> (instance method)</h5>

<p>The instance method <code>update_instance</code> makes it easy to run an update statement against the current model document by defaulting the <code>query</code> used to <code>{'_id': self['_id']}</code>.</p>

<div class="highlight highlight-python"><pre><span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">some_id</span><span class="p">)</span>
<span class="n">order</span><span class="o">.</span><span class="n">update_instance</span><span class="p">({</span><span class="s">'$unset'</span><span class="p">:</span> <span class="p">{</span><span class="s">'line_items'</span><span class="p">:</span> <span class="mi">1</span><span class="p">}})</span>
</pre></div>

<h6>
<a name="note" class="anchor" href="#note"><span class="octicon octicon-link"></span></a>Note</h6>

<p><code>model.update</code> (instance method) will delegate to python's dictionary API:</p>

<div class="highlight highlight-python"><pre><span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">some_id</span><span class="p">)</span>
<span class="n">order</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">'line_items'</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="k">print</span> <span class="n">order</span><span class="p">[</span><span class="s">'line_items'</span><span class="p">]</span>  <span class="c"># 1</span>
</pre></div>

<h4>
<a name="counting-items" class="anchor" href="#counting-items"><span class="octicon octicon-link"></span></a>Counting items</h4>

<div class="highlight highlight-python"><pre><span class="n">Order</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>

<h4>
<a name="custom-class-methods" class="anchor" href="#custom-class-methods"><span class="octicon octicon-link"></span></a>Custom class methods</h4>

<p>You can dynamically add custom class methods to your model by using the model's <code>class_method</code> decorator function. These are useful for adding custom finder methods to your model:</p>

<div class="highlight highlight-python"><pre><span class="nd">@BlogPost.class_method</span>
<span class="k">def</span> <span class="nf">find_by_author</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">author</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s">"author"</span><span class="p">:</span> <span class="n">author</span><span class="p">})</span>

<span class="n">posts</span> <span class="o">=</span> <span class="n">BlogPost</span><span class="o">.</span><span class="n">find_by_author</span><span class="p">(</span><span class="s">"Jeff Atwood"</span><span class="p">)</span>
</pre></div>

<h3>
<a name="instance-methods" class="anchor" href="#instance-methods"><span class="octicon octicon-link"></span></a>Instance methods</h3>

<p>Instances of models allow documents to be easily created, manipulated, save and deleted.</p>

<h4>
<a name="creating-documents" class="anchor" href="#creating-documents"><span class="octicon octicon-link"></span></a>Creating documents</h4>

<p>Create a new instance of a model by passing the document as a Python dict into the constructor:</p>

<div class="highlight highlight-python"><pre><span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">({</span>
    <span class="s">"line_items"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="s">"item_name"</span><span class="p">:</span> <span class="s">"iPhone 5"</span><span class="p">,</span> <span class="s">"price"</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"item_name"</span><span class="p">:</span> <span class="s">"Mac Mini"</span><span class="p">,</span> <span class="s">"price"</span><span class="p">:</span> <span class="mi">500</span><span class="p">}</span>
    <span class="p">],</span>
    <span class="s">"total_due"</span><span class="p">:</span> <span class="mi">700</span>
<span class="p">})</span>
</pre></div>

<h4>
<a name="validating-documents" class="anchor" href="#validating-documents"><span class="octicon octicon-link"></span></a>Validating documents</h4>

<p>You can validate a document against its Schema by simply calling <code>validate</code> on the document instance:</p>

<div class="highlight highlight-python"><pre><span class="n">order</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>  <span class="c"># raises a ValidationException is the document is invalid</span>
</pre></div>

<h4>
<a name="saving-documents" class="anchor" href="#saving-documents"><span class="octicon octicon-link"></span></a>Saving documents</h4>

<p>In order to persist document changes to the DB, the model can be saved:</p>

<div class="highlight highlight-python"><pre><span class="n">order</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>

<p>Saving an existing, previously loaded document will cause it to be updated. Saving a new document will cause it to be inserted.
In all cases, saving a document results in schema defaults being applied where appropriate and the document being validated before it is saved to the database. In the event of a validation failure <code>save()</code> will raise a ValidationException.</p>

<h4>
<a name="deleting-documents" class="anchor" href="#deleting-documents"><span class="octicon octicon-link"></span></a>Deleting documents</h4>

<p>A document may be removed from the underlying collection by calling the <code>remove()</code> method on the associated model instance:</p>

<div class="highlight highlight-python"><pre><span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">some_id</span><span class="p">)</span>
<span class="n">order</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>  <span class="c"># document is removed from the DB</span>
</pre></div>

<h4>
<a name="reload" class="anchor" href="#reload"><span class="octicon octicon-link"></span></a>Reload</h4>

<p>You can easily reload a model instance from the database by calling the <code>reload</code> method on an instance:</p>

<div class="highlight highlight-python"><pre><span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">some_id</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">order</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
</pre></div>

<h4>
<a name="custom-instance-methods" class="anchor" href="#custom-instance-methods"><span class="octicon octicon-link"></span></a>Custom instance methods</h4>

<p>Custom instance methods can be added to a model using the model's <code>instance_method</code> decorator. This comes in handy when you want to wrap up common operations on a document:</p>

<div class="highlight highlight-python"><pre><span class="nd">@Order.instance_method</span>
<span class="k">def</span> <span class="nf">add_line_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">line_items</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s">'item_name'</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s">'price'</span><span class="p">:</span> <span class="n">price</span><span class="p">})</span>

<span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">some_id</span><span class="p">)</span>
<span class="n">order</span><span class="o">.</span><span class="n">add_line_item</span><span class="p">(</span><span class="s">"iPad Mini"</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
<span class="n">order</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>

<h3>
<a name="scopes-beta" class="anchor" href="#scopes-beta"><span class="octicon octicon-link"></span></a>"Scopes" (beta)</h3>

<p>Scopes are a dynamic way of attaching reusable sets of query options to a model which can then be chained together dynamically in order to run actual queries against the model's underlying collection.</p>

<p>For example:</p>

<div class="highlight highlight-python"><pre><span class="nd">@Order.scope</span>
<span class="k">def</span> <span class="nf">before</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">"created_date"</span><span class="p">:</span> <span class="p">{</span><span class="s">"$lt"</span><span class="p">:</span> <span class="n">date</span><span class="p">}}</span>

<span class="nd">@Order.scope</span>
<span class="k">def</span> <span class="nf">single_item</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">"items"</span><span class="p">:</span> <span class="p">{</span><span class="s">"$size"</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}</span>

<span class="c"># Obtains a list of orders which were created before 20120101 which have a single line item.</span>
<span class="n">orders</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">single_item</span><span class="p">()</span>
</pre></div>

<h4>
<a name="combining-queries-with-nested-criteria" class="anchor" href="#combining-queries-with-nested-criteria"><span class="octicon octicon-link"></span></a>Combining queries with nested criteria</h4>

<p>When dealing with multiple chained scopes, Mongothon uses a "deep merge, last query wins" approach to combine multiple query dicts into a single query dicts. This ensures that queries with nested query elements may be combined just as easily as simple key-value queries.</p>

<p>Examples:</p>

<div class="highlight highlight-python"><pre><span class="nd">@Order.scope</span>
<span class="k">def</span> <span class="nf">item_priced_lt</span><span class="p">(</span><span class="n">price</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">"items"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">"$elemMatch"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"price"</span><span class="p">:</span> <span class="p">{</span><span class="s">"$lt"</span><span class="p">:</span> <span class="n">price</span><span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}}</span>

<span class="nd">@Order.scope</span>
<span class="k">def</span> <span class="nf">item_priced_gt</span><span class="p">(</span><span class="n">price</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">"items"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">"$elemMatch"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"price"</span><span class="p">:</span> <span class="p">{</span><span class="s">"$gt"</span><span class="p">:</span> <span class="n">price</span><span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}}</span>

<span class="nd">@Order.scope</span>
<span class="k">def</span> <span class="nf">item_named</span><span class="p">(</span><span class="n">name</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">"items"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">"$elemMatch"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"name"</span><span class="p">:</span> <span class="n">name</span>
        <span class="p">}</span>
    <span class="p">}}</span>

<span class="n">orders</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">item_named</span><span class="p">(</span><span class="s">'iPhone'</span><span class="p">)</span><span class="o">.</span><span class="n">item_priced_lt</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="o">.</span><span class="n">item_priced_gt</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>

<span class="c"># Resultant query:</span>
<span class="c">#   {"items": {</span>
<span class="c">#       "$elemMatch": {</span>
<span class="c">#           "name": "iPhone",</span>
<span class="c">#           "price": {"$gt": 200, "$lt": 500}</span>
<span class="c">#       }</span>
<span class="c">#   }}</span>

</pre></div>

<p>Other notes:</p>

<ul>
<li>If you have multiple queries specifying a list of values (e.g. as part of an $in statement) for the same field, Mongothon will combine the two lists for you. <code>{'tags': {'$in': ['red', 'blue']}</code> + <code>{'tags': {'$in': ['green', 'blue']}</code> =&gt; <code>{'tags': {'$in': ['red', 'blue', 'green']}</code>
</li>
<li>Even with deep merging, if you attempt to combine two queries which specify different values for matching a field, the last scope in the chain will win.</li>
</ul><h4>
<a name="implementing-scope-functions" class="anchor" href="#implementing-scope-functions"><span class="octicon octicon-link"></span></a>Implementing scope functions</h4>

<p>A "scope" function is simply a function which returns up to three return values:</p>

<ul>
<li>A query dict</li>
<li>A projection dict</li>
<li>An options dict, containing a list of kwargs suitable for passing to PyMongo's <code>find</code> method.</li>
</ul><p>A scope is registered with a given model by using the model's <code>scope</code> decorator.</p>

<p>Some example scopes:</p>

<div class="highlight highlight-python"><pre><span class="nd">@BlogPost.scope</span>
<span class="k">def</span> <span class="nf">author</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">"""A scope which restricts the query to only blog posts by the given author"""</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">"name"</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span>

<span class="nd">@BlogPost.scope</span>
<span class="k">def</span> <span class="nf">id_only</span><span class="p">():</span>
    <span class="sd">"""Only return the ID from the query"""</span>
    <span class="k">return</span> <span class="p">{},</span> <span class="p">{</span><span class="s">"_id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

<span class="nd">@BlogPost.scope</span>
<span class="k">def</span> <span class="nf">by_created_date</span><span class="p">():</span>
    <span class="sd">"""Sorts the query results by created date"""</span>
    <span class="k">return</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{</span><span class="s">"sort"</span><span class="p">:</span> <span class="p">[</span><span class="s">"created_date"</span><span class="p">,</span> <span class="mi">1</span><span class="p">]}</span>
</pre></div>

<h4>
<a name="using-scopes" class="anchor" href="#using-scopes"><span class="octicon octicon-link"></span></a>Using scopes</h4>

<p>Scope functions, once registered to a given model, can be called on the model class to dynamically build up a query context in a chainable manner.</p>

<p>Once the query context has been built up, it will executed as soon as the caller attempts to access the results.</p>

<div class="highlight highlight-python"><pre><span class="c"># Finds all BlogPosts with a given author, only returning their IDs</span>
<span class="n">posts</span> <span class="o">=</span> <span class="n">BlogPost</span><span class="o">.</span><span class="n">author</span><span class="p">(</span><span class="s">"bob"</span><span class="p">)</span><span class="o">.</span><span class="n">id_only</span><span class="p">()</span>

<span class="c"># The actual query is only executed against Mongo when we attempt access</span>
<span class="n">first</span> <span class="o">=</span> <span class="n">posts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

<p>The builder API which allows scopes to be chained together in this manner implements the Python iterator protocol as well:</p>

<div class="highlight highlight-python"><pre><span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">BlogPost</span><span class="o">.</span><span class="n">author</span><span class="p">(</span><span class="s">"bob"</span><span class="p">)</span><span class="o">.</span><span class="n">id_only</span><span class="p">():</span>
    <span class="c"># Do something</span>
</pre></div>

<p>You can call any pymongo <code>Cursor</code> method via the scope builder:</p>

<div class="highlight highlight-python"><pre><span class="n">num_posts_by_bob</span> <span class="o">=</span> <span class="n">BlogPost</span><span class="o">.</span><span class="n">author</span><span class="p">(</span><span class="s">"bob"</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

<span class="n">ten_posts_by_bob</span> <span class="o">=</span> <span class="n">BlogPost</span><span class="o">.</span><span class="n">author</span><span class="p">(</span><span class="s">"bob"</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

<p>Furthermore, scopes can be further refined even after you have performed access on them:</p>

<div class="highlight highlight-python"><pre><span class="n">posts</span> <span class="o">=</span> <span class="n">BlogPost</span><span class="o">.</span><span class="n">author</span><span class="p">(</span><span class="s">'bob'</span><span class="p">)</span>
<span class="k">print</span> <span class="s">"Bob has written a total of {} posts"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">posts</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

<span class="n">gardening_posts</span> <span class="o">=</span> <span class="n">posts</span><span class="o">.</span><span class="n">tagged</span><span class="p">(</span><span class="s">'gardening'</span><span class="p">)</span>
<span class="k">print</span> <span class="s">"{} of these are about gardening"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gardening_posts</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
</pre></div>

<h3>
<a name="events" class="anchor" href="#events"><span class="octicon octicon-link"></span></a>Events</h3>

<p>Mongothon Models emit events at various points in the lifecycle of a model instance. You can register one or more handler functions for a given event against the model class. These functions are then invoked at the point a model instance emits the event.</p>

<p>To register a function to receive an event, use the <code>on</code> model class method, either by calling it directly passing your handler function, or as a decorator:</p>

<div class="highlight highlight-python"><pre>
<span class="k">def</span> <span class="nf">log_save</span><span class="p">(</span><span class="n">blog_post</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">'Blog post {} was saved!'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">blog_post</span><span class="p">[</span><span class="s">'_id'</span><span class="p">]))</span>

<span class="c"># Register the handler function</span>
<span class="n">BlogPost</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s">'did_save'</span><span class="p">,</span> <span class="n">log_save</span><span class="p">)</span>

<span class="o">...</span>

<span class="nd">@BlogPost.on</span><span class="p">(</span><span class="s">'did_save'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">log_save</span><span class="p">(</span><span class="n">blog_post</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">'Blog post {} was saved!'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">blog_post</span><span class="p">[</span><span class="s">'_id'</span><span class="p">]))</span>
</pre></div>

<h4>
<a name="implementing-handler-functions" class="anchor" href="#implementing-handler-functions"><span class="octicon octicon-link"></span></a>Implementing handler functions</h4>

<p>A valid event handler function should always expect to receive:</p>

<ul>
<li>the model instance from which the event is being emitted as it's first argument</li>
<li>any other specific arguments associated with the given event (see below for a list of standard events and their additional arguments).</li>
</ul><div class="highlight highlight-python"><pre><span class="nd">@BlogPost.on</span><span class="p">(</span><span class="s">'did_remove'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">log_remove</span><span class="p">(</span><span class="n">blog_post</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">'Blog post {} was removed!'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">blog_post</span><span class="p">[</span><span class="s">'_id'</span><span class="p">]))</span>

<span class="nd">@BlogPost.on</span><span class="p">(</span><span class="s">'did_update'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">log_update</span><span class="p">(</span><span class="n">blog_post</span><span class="p">,</span> <span class="n">document</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">'Blog post {} was updated using document'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">blog_post</span><span class="p">[</span><span class="s">'_id'</span><span class="p">],</span> <span class="n">document</span><span class="p">))</span>

</pre></div>

<p>When emitting custom events (see below for more details), this allows essentially any arguments to be passed to all handlers registered for that event.</p>

<div class="highlight highlight-python"><pre><span class="nd">@BlogPost.on</span><span class="p">(</span><span class="s">'archived'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">log_archived</span><span class="p">(</span><span class="n">blog_post</span><span class="p">,</span> <span class="n">archived_by</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">'Blog post {} was archived by {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">blog_post</span><span class="p">[</span><span class="s">'_id'</span><span class="p">],</span> <span class="n">archived_by</span><span class="p">))</span>

<span class="o">...</span>

<span class="k">def</span> <span class="nf">archive_blog_post</span><span class="p">(</span><span class="n">post_id</span><span class="p">,</span> <span class="n">user_email</span><span class="p">):</span>
    <span class="n">blog_post</span> <span class="o">=</span> <span class="n">BlogPost</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">post_id</span><span class="p">)</span>
    <span class="n">blog_post</span><span class="p">[</span><span class="s">'archived'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">blog_post</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">blog_post</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s">'archived'</span><span class="p">,</span> <span class="n">archived_by</span><span class="o">=</span><span class="n">user_email</span><span class="p">)</span>
</pre></div>

<h4>
<a name="standard-events" class="anchor" href="#standard-events"><span class="octicon octicon-link"></span></a>Standard events</h4>

<p>Every Mongothon model emits the following events as part of its lifecycle:</p>

<table>
<thead><tr>
<th>Event</th>
<th>Additional args</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr>
<td><code>'did_init'</code></td>
<td>None</td>
<td>Emitted whenever a new model object instance is initialized.</td>
</tr>
<tr>
<td><code>'did_find'</code></td>
<td>None</td>
<td>Emitted when a model object is instantiated as the result of database lookup. Fires after <code>'did_init'</code>.</td>
</tr>
<tr>
<td>
<code>'will_validate</code>'</td>
<td>
<code>working</code> - the working copy of the <code>Model</code> instance.</td>
<td>Emitted just before a model is validated against it's schema.</td>
</tr>
<tr>
<td>
<code>'did_validate</code>'</td>
<td>
<code>working</code> - the working copy of the <code>Model</code> instance.</td>
<td>Emitted just after a model is validated against it's schema.</td>
</tr>
<tr>
<td><code>'will_apply_defaults'</code></td>
<td>None</td>
<td>Emitted just before defaults (from the associated schema) are applied to the <code>Model</code> instance .</td>
</tr>
<tr>
<td><code>'did_apply_defaults'</code></td>
<td>None</td>
<td>Emitted just after defaults (from the associated schema) are applied to the <code>Model</code> instance .</td>
</tr>
<tr>
<td><code>'will_save'</code></td>
<td>
<code>working</code> - the working copy of the <code>Model</code> instance.</td>
<td>Emitted just before a model is saved to the database. Fires <em>after</em> validation (and it's associated events).</td>
</tr>
<tr>
<td><code>'did_save'</code></td>
<td>None</td>
<td>Emitted just after a model is saved to the database.</td>
</tr>
<tr>
<td><code>'will_update'</code></td>
<td>All arguments provided to <code>update_instance()</code>.</td>
<td>Emitted just before an <code>update</code> is performed for the given model instance.</td>
</tr>
<tr>
<td><code>'did_update'</code></td>
<td>All arguments provided to <code>update_instance()</code>.</td>
<td>Emitted just after an <code>update</code> is performed for the given model instance.</td>
</tr>
<tr>
<td><code>'will_remove'</code></td>
<td>All arguments provided to <code>remove()</code>.</td>
<td>Emitted just before an <code>remove</code> is performed for the given model instance.</td>
</tr>
<tr>
<td><code>'did_remove'</code></td>
<td>All arguments provided to <code>reomve()</code>.</td>
<td>Emitted just after an <code>remove</code> is performed for the given model instance.</td>
</tr>
</tbody>
</table><h5>
<a name="working-copy-event-arguments" class="anchor" href="#working-copy-event-arguments"><span class="octicon octicon-link"></span></a>Working copy event arguments</h5>

<p><code>'will_validate'</code>, <code>'did_validate'</code> and <code>'will_save'</code> events include a <code>working</code> argument which is a working copy of the model instance. To properly understand what this argument is, it is useful to think about the steps Mongothon goes through when saving a Mongothon <code>Model</code> instance:</p>

<ol>
<li>A working (deep) copy of the model instance is created.</li>
<li>Any schema default values are applied to the working copy, without affecting the primary object instance.</li>
<li>The working copy is validated against the model's schema.</li>
<li>If validation passes, an attempt is made to save the working copy to the underlying database collection.</li>
<li>If the database save operation succeeds, the working copy is merged back into the primary object instance so that it reflects the document in the collection.</li>
</ol><p>So for these events which receive the <code>working</code> argument, depending on the model's schema it is possible that this object may contain different values to the primary model instance.</p>

<p>Also note that if you want to implement any universal "pre-save" updates to the model just before it is saved (e.g. updating a 'modified' timestamp), you can do this simply by manipulating the working copy.</p>

<h4>
<a name="emitting-custom-events" class="anchor" href="#emitting-custom-events"><span class="octicon octicon-link"></span></a>Emitting custom events</h4>

<p>As well as the standard set of events listed above which are emitted by models, it's also possible to use the <code>Model</code> event bus for any custom events you want to emit.</p>

<p>To emit a custom event, just invoke <code>emit</code> on a give  model instance passing a string to identify the type of event, along with any custom arguments which are relevant to that event.</p>

<p>(Note that you don't need to pass the model instance itself as an argument to <code>emit</code>).</p>

<div class="highlight highlight-python"><pre><span class="n">post</span> <span class="o">=</span> <span class="n">BlogPost</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">post_id</span><span class="p">)</span>
<span class="n">post</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s">'loaded'</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
</pre></div>

<p>Generally speaking, rather than emitting events directly from your model-consuming code, a better pattern is to implement an <code>@instance_method</code> on your <code>Model</code> which wraps up some operation and emit an event from within that method.</p>

<p>To handle a custom event, just register a handler function in the same way you would for a standard event:</p>

<div class="highlight highlight-python"><pre><span class="n">BlogPost</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s">'loaded'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">log_load</span><span class="p">(</span><span class="n">post</span><span class="p">,</span> <span class="n">loaded_time</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">'Loaded post {} at {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">post</span><span class="p">[</span><span class="s">'_id'</span><span class="p">],</span> <span class="n">loaded_time</span><span class="p">))</span>
</pre></div>

<h3>
<a name="model-state" class="anchor" href="#model-state"><span class="octicon octicon-link"></span></a>Model State</h3>

<p>Mongothon models provide a few handy methods which let you determine the document's current persistence state:</p>

<div class="highlight highlight-python"><pre><span class="n">post</span> <span class="o">=</span> <span class="n">BlogPost</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">post</span><span class="o">.</span><span class="n">is_new</span><span class="p">()</span>

<span class="n">post</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">post</span><span class="o">.</span><span class="n">is_new</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">post</span><span class="o">.</span><span class="n">is_persisted</span><span class="p">()</span>

<span class="n">post</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">post</span><span class="o">.</span><span class="n">is_new</span><span class="p">()</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">post</span><span class="o">.</span><span class="n">is_persisted</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">port</span><span class="o">.</span><span class="n">is_deleted</span><span class="p">()</span>
</pre></div>

<h1>
<a name="developing-and-contributing" class="anchor" href="#developing-and-contributing"><span class="octicon octicon-link"></span></a>Developing and Contributing</h1>

<p>To run Mongothon's tests, simply run <code>python setup.py nosetests</code> at the command line.</p>

<p>All contributions submitted as GitHub pull requests are warmly received.</p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Mongothon maintained by <a href="https://github.com/gamechanger">gamechanger</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
